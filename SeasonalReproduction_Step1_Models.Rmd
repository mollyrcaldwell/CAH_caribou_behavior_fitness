---
title: "Seasonal Parturition: Step 1- Models"
output: html_document
date: "2025-09-16"
---

```{r}
library(glmmTMB)
library(tidyverse)
library(Hmisc)
library(corrplot)
library(MuMIn)
library(flextable)
library(officer)
library(readxl)
```

```{r setup}
setwd("~/OneDrive - University of Wyoming/Documents/USGS_AK_Caribou/")
```

# Load data

```{r}
# load early and late summer behavior and fitness data
early_beh <- read.csv("./Code_Output/early_behavior_fitness.csv")
late_beh <- read.csv("./Code_Output/late_behavior_fitness.csv")
```

# Calving

## Seasonal behaviors

### Early summer
Effect of breadths & averages of early summer behaviors on the following year's calving

```{r}
# check correlation of annual behaviors
beh_metrics <- c("avg_biom", "I(avg_biom^2)", "avg_dn", "avg_de", "resource_vol",
                 "avg_dist_m", "avg_sinuosity", "HR_area_km2", "centroid_x",
               "centroid_y", "move_vol")

early_beh_corr = cor(early_beh %>% select(all_of(c("avg_biom", "avg_dn", 
                                               "avg_de", "resource_vol",
                                               "avg_dist_m", "avg_sinuosity", 
                                               "HR_area_km2", "centroid_x",
                                               "centroid_y", "move_vol"))))
corrplot(early_beh_corr, method = 'number', number.cex = 0.7) 
```

```{r}
# loop through behavior metrics, running logistic model
beh_part_early_mod <- vector(mode = "list", length = length(beh_metrics))

for(i in 1:length(beh_metrics)){
  print(i)
  

  form <- as.formula(paste("Next_Yr_Calf_Present ~ Current_Calf_Present + ", beh_metrics[[i]]))
  
  beh_part_early_mod[[i]] <- glmmTMB(formula = form,
                            data = early_beh,
                            family = binomial(link = "logit"))
  
}

names(beh_part_early_mod) <- beh_metrics
```

```{r}
# compile model results into a dataframe
beh_part_early_results <- vector(mode = "list", length = length(beh_part_early_mod))

for(i in 1:length(beh_part_early_mod)){
  beh_part_early_results[[i]] <- as.data.frame(summary(beh_part_early_mod[[i]])$coefficients$cond)
  beh_part_early_results[[i]]$predictor <- rownames(beh_part_early_results[[i]])
  rownames(beh_part_early_results[[i]]) <- NULL
  }
  
beh_part_early_results <- bind_rows(beh_part_early_results)

# filter out intercept
beh_part_early_results <- beh_part_early_results %>% 
  filter(predictor != "(Intercept)")

# arrange by p-value
beh_part_early_results <- beh_part_early_results %>% 
  arrange(`Pr(>|z|)`) 
```

### Behavior x annual forage & insect conditions
Effect of breadths & averages of early summer behaviors interacted with forage & insect conditions on the following year's parturition

Conditions used: average and SD of biomass, DN, mosquito

```{r}
# name behavior metrics and conditions to loop over
beh_metrics <- c("avg_biom", "I(avg_biom^2)", "avg_dn", "avg_de", "resource_vol",
                 "avg_dist_m", "avg_sinuosity", "HR_area_km2", "centroid_x",
               "centroid_y", "move_vol")
cond_metrics <- c("avg_biom_herd", "avg_dn_herd")
```

```{r}
# loop through behavior metrics, running logistic model
beh_cond_part_early_mod <- vector(mode = "list", length = length(beh_metrics))

for(i in 1:length(beh_metrics)){
  print(i)
  beh_cond_part_early_mod[[i]] <- vector(mode = "list", length = length(cond_metrics))
  
  for(j in 1:length(cond_metrics)){
  

  form <- as.formula(paste("Next_Yr_Calf_Present ~ Current_Calf_Present +", beh_metrics[[i]], " * avg_mosq_herd + ", beh_metrics[[i]], " * ", cond_metrics[[j]]))
  
  beh_cond_part_early_mod[[i]][[j]] <- glmmTMB(formula = form,
                            data = early_beh,
                            family = binomial(link = "logit"))
  
  }
  
  names(beh_cond_part_early_mod[[i]]) <- cond_metrics
}

names(beh_cond_part_early_mod) <- beh_metrics
```

```{r}
# compile model results into a dataframe
beh_cond_part_early_results <- vector(mode = "list", length = length(beh_cond_part_early_mod))

for(i in 1:length(beh_cond_part_early_mod)){
  beh_cond_part_early_results[[i]] <- vector(mode = "list", 
                                       length = length(beh_cond_part_early_mod[[i]]))
  
  for(j in 1:length(beh_cond_part_early_mod[[i]])){

      
  beh_cond_part_early_results[[i]][[j]] <- as.data.frame(summary(beh_cond_part_early_mod[[i]][[j]])$coefficients$cond)
  beh_cond_part_early_results[[i]][[j]]$beh <- names(beh_cond_part_early_mod)[[i]]
  beh_cond_part_early_results[[i]][[j]]$cond <- names(beh_cond_part_early_mod[[i]])[[j]]
  beh_cond_part_early_results[[i]][[j]]$predictor <- rownames(beh_cond_part_early_results[[i]][[j]])
  rownames(beh_cond_part_early_results[[i]][[j]]) <- NULL
    }
    beh_cond_part_early_results[[i]] <- bind_rows(beh_cond_part_early_results[[i]])
  }


beh_cond_part_early_results <- bind_rows(beh_cond_part_early_results)

# filter out intercept
beh_cond_part_early_results <- beh_cond_part_early_results %>% 
  filter(predictor != "(Intercept)")

# arrange by p-value
beh_cond_part_early_results <- beh_cond_part_early_results %>% 
  arrange(`Pr(>|z|)`)
```

```{r}
# replace models with insignificant interactions with model without the interaction

beh_cond_part_early_mod[[2]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + I(avg_biom^2) + 
                                               avg_mosq_herd + avg_biom_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[2]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + I(avg_biom^2) + 
                                               avg_mosq_herd + avg_dn_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[3]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~
                                               Current_Calf_Present + avg_dn + 
                                               avg_mosq_herd + avg_dn_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[4]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + avg_de + 
                                               avg_mosq_herd + avg_biom_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[4]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + avg_de + 
                                               avg_mosq_herd + avg_dn_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[5]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                               resource_vol + avg_mosq_herd + 
                                               avg_biom_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[5]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                               resource_vol + avg_mosq_herd + 
                                               resource_vol * avg_dn_herd +
                                               resource_vol : avg_dn +
                                               avg_de,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[6]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + avg_dist_m + 
                                               avg_mosq_herd + avg_biom_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[6]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~
                                               Current_Calf_Present + avg_dist_m + 
                                               avg_mosq_herd + avg_dn_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[7]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~
                                               Current_Calf_Present + avg_sinuosity + 
                                               avg_mosq_herd + avg_biom_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[7]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~
                                               Current_Calf_Present + avg_sinuosity + 
                                               avg_mosq_herd + avg_dn_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[8]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~
                                               Current_Calf_Present + HR_area_km2 + 
                                               avg_mosq_herd + avg_biom_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[8]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                               HR_area_km2 * avg_mosq_herd + 
                                               avg_dn_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))


beh_cond_part_early_mod[[9]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + centroid_x + 
                                               avg_mosq_herd + avg_biom_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[9]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~
                                               Current_Calf_Present + centroid_x + 
                                               avg_mosq_herd + avg_dn_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[10]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + centroid_y + 
                                               avg_mosq_herd + avg_biom_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[10]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + centroid_y + 
                                               avg_mosq_herd + avg_dn_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[11]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                                move_vol + avg_biom_herd +
                                                avg_mosq_herd +
                                                 avg_dist_m +
                                                 avg_sinuosity,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_part_early_mod[[11]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                                move_vol + avg_mosq_herd + 
                                                 avg_dn_herd +
                                                 avg_dist_m +
                                                avg_sinuosity,
                            data = early_beh,
                            family = binomial(link = "logit"))
```


```{r}
# AIC table
### first, rearrange model list
beh_cond_early_aic_mod <- list()
for (parent in names(beh_cond_part_early_mod)) {
  for (child in names(beh_cond_part_early_mod[[parent]])) {
    beh_cond_early_aic_mod[[paste(parent, child, sep = " ")]] <- beh_cond_part_early_mod[[parent]][[child]]
  }
}

# add null model to each model set
beh_cond_early_aic_mod[[23]] <- glmmTMB(Next_Yr_Calf_Present ~ Current_Calf_Present + avg_biom_herd + avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

names(beh_cond_early_aic_mod)[[23]] <- "NULL_biom"

beh_cond_early_aic_mod[[24]] <- glmmTMB(Next_Yr_Calf_Present ~ Current_Calf_Present + avg_dn_herd + avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

names(beh_cond_early_aic_mod)[[24]] <- "NULL_dn"

```
 
```{r}
# now, generate AIC table for each model set - per behavior type & environ conditions (forage quality vs forage quantity)
grp <- case_when(
  str_detect(names(beh_cond_early_aic_mod), "biom_herd") & 
    str_detect(names(beh_cond_early_aic_mod), "centroid|HR") ~ "space_quant",
  str_detect(names(beh_cond_early_aic_mod), "dn_herd|de_herd") & 
    str_detect(names(beh_cond_early_aic_mod), "centroid|HR") ~ "space_qual",
  str_detect(names(beh_cond_early_aic_mod), "biom_herd") & 
    str_detect(names(beh_cond_early_aic_mod), "move|dist|sinuos") ~ "move_quant",
  str_detect(names(beh_cond_early_aic_mod), "dn_herd|de_herd") & 
    str_detect(names(beh_cond_early_aic_mod), "move|dist|sinuos") ~ "move_qual",
  str_detect(names(beh_cond_early_aic_mod), "biom_herd") & 
    str_detect(names(beh_cond_early_aic_mod), "avg_biom |avg_dn |avg_de |resource_vol|avg_biom\\^2") ~ "for_quant",
  str_detect(names(beh_cond_early_aic_mod), "dn_herd|de_herd") & 
    str_detect(names(beh_cond_early_aic_mod), "avg_biom |avg_dn |avg_de |resource_vol|avg_biom\\^2") ~ "for_qual",
  TRUE ~ names(beh_cond_early_aic_mod)
)

beh_cond_early_aic_mod <- split(beh_cond_early_aic_mod, grp)
null_mods <- beh_cond_early_aic_mod[str_detect(names(beh_cond_early_aic_mod), "NULL")]
beh_cond_early_aic_mod[str_detect(names(beh_cond_early_aic_mod), "NULL")] <- NULL

aic_table <- list()

for(i in 1:length(beh_cond_early_aic_mod)){
 # Generate AIC table for each group
  if(str_detect(names(beh_cond_early_aic_mod)[[i]], "quant")){
    aic_table[[i]] <- MuMIn::model.sel(c(beh_cond_early_aic_mod[[i]],
                                              null_mods[["NULL_biom"]]))
    
      # extract model formula
      forms <- map_chr(c(beh_cond_early_aic_mod[[i]],
                          null_mods[["NULL_biom"]]), ~as.character(formula(.x))[[3]])
      forms <- data.frame(forms = forms, model = names(forms))
  
      # Add model names 
        aic_table[[i]] <- as.data.frame(aic_table[[i]]) %>%
          tibble::rownames_to_column("model")
  
      # join with formula
      aic_table[[i]] <- left_join(aic_table[[i]], forms)
      
  }else{
    aic_table[[i]] <- MuMIn::model.sel(c(beh_cond_early_aic_mod[[i]],
                                            null_mods[["NULL_dn"]]))
    
    # extract model formula
      forms <- map_chr(c(beh_cond_early_aic_mod[[i]],
                          null_mods[["NULL_dn"]]), ~as.character(formula(.x))[[3]])
      forms <- data.frame(forms = forms, model = names(forms))
  
      # Add model names 
        aic_table[[i]] <- as.data.frame(aic_table[[i]]) %>%
          tibble::rownames_to_column("model")
  
      # join with formula
      aic_table[[i]] <- left_join(aic_table[[i]], forms)
  }
}
  
aic_df_beh_cond_early <- bind_rows(aic_table)  

## subset to variables of interest
aic_df_beh_cond_early <- aic_df_beh_cond_early %>% 
  select(forms, df, logLik, AICc, delta)

## then, round values
aic_df_beh_cond_early <- aic_df_beh_cond_early %>%
  mutate(across(where(is.numeric), ~round(.x, 3)))

# make model formulas pretty
aic_df_beh_cond_early <- aic_df_beh_cond_early %>% 
  mutate(
    forms = str_replace_all(forms, "avg_biom_herd", "forage biomass"),
    forms = str_replace_all(forms, "avg_dn_herd", "dig. nitrogen"),
    forms = str_replace_all(forms, "avg_mosq_herd", "mosq. index"),
    forms = str_replace_all(forms, "avg_biom", "forage biomass use"),
    forms = str_replace_all(forms, "resource_vol", "forage use breadth"),
    forms = str_replace_all(forms, "avg_dn", "dig. nitrogen use"),
    forms = str_replace_all(forms, "avg_de", "dig. energy use"),
    forms = str_replace_all(forms, "avg_sinuosity", "daily sinuosity"),
    forms = str_replace_all(forms, "avg_dist_m", "daily displacement"),
    forms = str_replace_all(forms, "move_vol", "movement breadth"),
    forms = str_replace_all(forms, "HR_area_km2", "seasonal range area"),
    forms = str_replace_all(forms, "centroid_x", "seasonal range longitude"),
    forms = str_replace_all(forms, "centroid_y", "seasonal range latitude")
  ) %>% 
  filter(!str_detect(forms, "dig. energy use")) # remove dig. energy use from early summer

aic_df_beh_cond_early <- aic_df_beh_cond_early %>% mutate(forms = str_remove(forms, "Current_Calf_Present \\+\\ "))

aic_df_beh_cond_early <- aic_df_beh_cond_early %>% 
  mutate(forms = case_when(forms == "forage biomass + mosq. index" ~ "forage biomass + mosq. index (Null model, forage quantity)",
                           forms == "dig. nitrogen + mosq. index" ~ "dig. nitrogen + mosq. index (Null model, forage quality)",
                           TRUE ~ forms))

# format it as a flextable
ft <- flextable(aic_df_beh_cond_early)

# autofit column widths
ft <- autofit(ft)

# create a Word document and add the table
doc <- read_docx() %>%
  body_add_par("early behavior x condition parturition AIC", style = "heading 1") %>%
  body_add_flextable(ft)

# save the Word document
print(doc, target = "./Code_Output/early_behavior_cond_part_AIC.docx")
```

```{r}
# save models that are better than NULL for plotting
# save top models (delta AIC < NULL) for plotting
top_models <- list()

for(i in 1:length(aic_table)){
 delta_null <- aic_table[[i]] %>% 
    filter(str_detect(model, "NULL")) %>% 
  slice_min(delta) %>% 
    select(delta)
  
  top_aic_mod <- aic_table[[i]] %>% 
    filter(delta < delta_null$delta)
  
# pull models
  top_models[[i]] <- beh_cond_early_aic_mod[[i]][top_aic_mod$model]

}

top_models <- top_models %>%
  flatten() %>%
  keep(~ length(.) > 0)

# save models
saveRDS(top_models, "./Code_Output/early_cond_part_sig_models.rds")
```

### Late summer
Effect of breadths & averages of late summer behaviors on the following year's parturition

```{r}
# check correlation of late summer behaviors
beh_metrics <- c("avg_biom", "I(avg_biom^2)", "avg_dn", "avg_de", "resource_vol",
                 "avg_dist_m", "avg_sinuosity", "HR_area_km2", "centroid_x",
               "centroid_y", "move_vol")

late_beh_corr = cor(late_beh %>% select(all_of(c("avg_biom", "avg_dn", 
                                               "avg_de", "resource_vol",
                                               "avg_dist_m", "avg_sinuosity", 
                                               "HR_area_km2", "centroid_x",
                                               "centroid_y", "move_vol"))))
corrplot(late_beh_corr, method = 'number', number.cex = 0.7) 
```

```{r}
# loop through behavior metrics, running logistic model
beh_part_late_mod <- vector(mode = "list", length = length(beh_metrics))

for(i in 1:length(beh_metrics)){
  print(i)
  

  form <- as.formula(paste("Next_Yr_Calf_Present ~ Current_Calf_Present + ", beh_metrics[[i]]))
  
  beh_part_late_mod[[i]] <- glmmTMB(formula = form,
                            data = late_beh,
                            family = binomial(link = "logit"))
  
}

names(beh_part_late_mod) <- beh_metrics
```

```{r}
# compile model results into a dataframe
beh_part_late_results <- vector(mode = "list", length = length(beh_part_late_mod))

for(i in 1:length(beh_part_late_mod)){
  beh_part_late_results[[i]] <- as.data.frame(summary(beh_part_late_mod[[i]])$coefficients$cond)
  beh_part_late_results[[i]]$predictor <- rownames(beh_part_late_results[[i]])
  rownames(beh_part_late_results[[i]]) <- NULL
  }
  
beh_part_late_results <- bind_rows(beh_part_late_results)

# filter out intercept
beh_part_late_results <- beh_part_late_results %>% 
  filter(predictor != "(Intercept)")

# arrange by p-value
beh_part_late_results <- beh_part_late_results %>% 
  arrange(`Pr(>|z|)`) 
```

### Behavior x annual forage & insect conditions
Effect of breadths & averages of late summer behaviors interacted with forage & insect conditions on the following year's parturition

Conditions used: average and SD of biomass and fly indices

```{r}
# name behavior metrics and conditions to loop over
beh_metrics <- c("avg_biom", "I(avg_biom^2)", "avg_dn", "avg_de", "resource_vol",
                 "avg_dist_m", "avg_sinuosity", "HR_area_km2", "centroid_x",
               "centroid_y", "move_vol")
cond_metrics <- c("avg_biom_herd", "avg_de_herd")
```

```{r}
# loop through behavior metrics, running logistic model
beh_cond_part_late_mod <- vector(mode = "list", length = length(beh_metrics))

for(i in 1:length(beh_metrics)){
  print(i)
  beh_cond_part_late_mod[[i]] <- vector(mode = "list", length = length(cond_metrics))
  
  for(j in 1:length(cond_metrics)){
  

   form <- as.formula(paste("Next_Yr_Calf_Present ~ Current_Calf_Present +", beh_metrics[[i]], " * avg_fly_herd + ", beh_metrics[[i]], " * ", cond_metrics[[j]]))
  
  beh_cond_part_late_mod[[i]][[j]] <- glmmTMB(formula = form,
                            data = late_beh,
                            family = binomial(link = "logit"))
  
  }
  
  names(beh_cond_part_late_mod[[i]]) <- cond_metrics
}

names(beh_cond_part_late_mod) <- beh_metrics
```

```{r}
# replace models with insignificant interactions with model without the interaction
beh_cond_part_late_mod[[1]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              avg_biom * avg_fly_herd + 
                                              avg_de_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[2]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              I(avg_biom^2) + 
                                              avg_fly_herd + 
                                              avg_biom_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[2]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              I(avg_biom^2) + 
                                              avg_fly_herd + 
                                              avg_de_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[3]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~
                                               Current_Calf_Present + 
                                              avg_dn * avg_fly_herd +
                                              avg_biom_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[3]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~
                                               Current_Calf_Present + 
                                              avg_dn * avg_fly_herd + 
                                              avg_de_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[4]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              avg_de + avg_fly_herd + 
                                              avg_biom_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[4]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              avg_de + avg_fly_herd + 
                                              avg_de_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[5]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              resource_vol * avg_fly_herd + 
                                              resource_vol *  avg_biom_herd +
                                               resource_vol * avg_biom,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[5]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              resource_vol * avg_fly_herd +
                                              resource_vol * avg_de_herd +
                                              resource_vol * avg_biom,
                            data = late_beh,
                            family = binomial(link = "logit"))


beh_cond_part_late_mod[[6]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              avg_dist_m + 
                                              avg_fly_herd + 
                                              avg_biom_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[6]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              avg_dist_m + 
                                              avg_fly_herd + 
                                              avg_de_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))


beh_cond_part_late_mod[[8]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              HR_area_km2 + avg_biom_herd + 
                                              avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[8]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              HR_area_km2 + avg_de_herd + 
                                              avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[9]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              centroid_x + avg_biom_herd + 
                                              avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[9]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              centroid_x + avg_de_herd + 
                                              avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[10]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                              centroid_y * avg_biom_herd + 
                                              avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))


beh_cond_part_late_mod[[11]][[1]] <- glmmTMB(Next_Yr_Calf_Present ~
                                               Current_Calf_Present + 
                                             move_vol + avg_biom_herd +
                                               avg_fly_herd + 
                                               avg_sinuosity,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_part_late_mod[[11]][[2]] <- glmmTMB(Next_Yr_Calf_Present ~ 
                                               Current_Calf_Present + 
                                             move_vol + avg_de_herd + 
                                              avg_fly_herd + 
                                               avg_sinuosity,
                            data = late_beh,
                            family = binomial(link = "logit"))
```


```{r}
# compile model results into a dataframe
beh_cond_part_late_results <- vector(mode = "list", length = length(beh_cond_part_late_mod))

for(i in 1:length(beh_cond_part_late_mod)){
  beh_cond_part_late_results[[i]] <- vector(mode = "list", 
                                       length = length(beh_cond_part_late_mod[[i]]))
  
  for(j in 1:length(beh_cond_part_late_mod[[i]])){

      
  beh_cond_part_late_results[[i]][[j]] <- as.data.frame(summary(beh_cond_part_late_mod[[i]][[j]])$coefficients$cond)
  beh_cond_part_late_results[[i]][[j]]$beh <- names(beh_cond_part_late_mod)[[i]]
  beh_cond_part_late_results[[i]][[j]]$cond <- names(beh_cond_part_late_mod[[i]])[[j]]
  beh_cond_part_late_results[[i]][[j]]$predictor <- rownames(beh_cond_part_late_results[[i]][[j]])
  rownames(beh_cond_part_late_results[[i]][[j]]) <- NULL
    }
    beh_cond_part_late_results[[i]] <- bind_rows(beh_cond_part_late_results[[i]])
  }


beh_cond_part_late_results <- bind_rows(beh_cond_part_late_results)

# filter out intercept
beh_cond_part_late_results <- beh_cond_part_late_results %>% 
  filter(predictor != "(Intercept)")

# arrange by p-value
beh_cond_part_late_results <- beh_cond_part_late_results %>% 
  arrange(`Pr(>|z|)`)
```

```{r}
# AIC table
### first, rearrange model list
beh_cond_late_aic_mod <- list()
for (parent in names(beh_cond_part_late_mod)) {
  for (child in names(beh_cond_part_late_mod[[parent]])) {
    beh_cond_late_aic_mod[[paste(parent, child, sep = " ")]] <- beh_cond_part_late_mod[[parent]][[child]]
  }
}

# add null model to each model set
beh_cond_late_aic_mod[[23]] <- glmmTMB(Next_Yr_Calf_Present ~ Current_Calf_Present + avg_biom_herd + avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

names(beh_cond_late_aic_mod)[[23]] <- "NULL_biom"

beh_cond_late_aic_mod[[24]] <- glmmTMB(Next_Yr_Calf_Present ~ Current_Calf_Present + avg_de_herd + avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

names(beh_cond_late_aic_mod)[[24]] <- "NULL_de"

```

```{r}
# now, generate AIC table for each model set - per behavior type & environ conditions (forage quality vs forage quantity)
grp <- case_when(
  str_detect(names(beh_cond_late_aic_mod), "biom_herd") & 
    str_detect(names(beh_cond_late_aic_mod), "centroid|HR") ~ "space_quant",
  str_detect(names(beh_cond_late_aic_mod), "dn_herd|de_herd") & 
    str_detect(names(beh_cond_late_aic_mod), "centroid|HR") ~ "space_qual",
  str_detect(names(beh_cond_late_aic_mod), "biom_herd") & 
    str_detect(names(beh_cond_late_aic_mod), "move|dist|sinuos") ~ "move_quant",
  str_detect(names(beh_cond_late_aic_mod), "dn_herd|de_herd") & 
    str_detect(names(beh_cond_late_aic_mod), "move|dist|sinuos") ~ "move_qual",
  str_detect(names(beh_cond_late_aic_mod), "biom_herd") & 
    str_detect(names(beh_cond_late_aic_mod), "avg_biom |avg_dn |avg_de |resource_vol|avg_biom\\^2") ~ "for_quant",
  str_detect(names(beh_cond_late_aic_mod), "dn_herd|de_herd") & 
    str_detect(names(beh_cond_late_aic_mod), "avg_biom |avg_dn |avg_de |resource_vol|avg_biom\\^2") ~ "for_qual",
  TRUE ~ names(beh_cond_late_aic_mod)
)

beh_cond_late_aic_mod <- split(beh_cond_late_aic_mod, grp)
null_mods <- beh_cond_late_aic_mod[str_detect(names(beh_cond_late_aic_mod), "NULL")]
beh_cond_late_aic_mod[str_detect(names(beh_cond_late_aic_mod), "NULL")] <- NULL

aic_table <- list()

for(i in 1:length(beh_cond_late_aic_mod)){
 # Generate AIC table for each group
  if(str_detect(names(beh_cond_late_aic_mod)[[i]], "quant")){
    aic_table[[i]] <- MuMIn::model.sel(c(beh_cond_late_aic_mod[[i]],
                                              null_mods[["NULL_biom"]]))
    
      # extract model formula
      forms <- map_chr(c(beh_cond_late_aic_mod[[i]],
                          null_mods[["NULL_biom"]]), ~as.character(formula(.x))[[3]])
      forms <- data.frame(forms = forms, model = names(forms))
  
      # Add model names 
        aic_table[[i]] <- as.data.frame(aic_table[[i]]) %>%
          tibble::rownames_to_column("model")
  
      # join with formula
      aic_table[[i]] <- left_join(aic_table[[i]], forms)
      
  }else{
    aic_table[[i]] <- MuMIn::model.sel(c(beh_cond_late_aic_mod[[i]],
                                            null_mods[["NULL_de"]]))
    
    # extract model formula
      forms <- map_chr(c(beh_cond_late_aic_mod[[i]],
                          null_mods[["NULL_de"]]), ~as.character(formula(.x))[[3]])
      forms <- data.frame(forms = forms, model = names(forms))
  
      # Add model names 
        aic_table[[i]] <- as.data.frame(aic_table[[i]]) %>%
          tibble::rownames_to_column("model")
  
      # join with formula
      aic_table[[i]] <- left_join(aic_table[[i]], forms)
  }
}
  
aic_df_beh_cond_late <- bind_rows(aic_table)  

## subset to variables of interest
aic_df_beh_cond_late <- aic_df_beh_cond_late %>% 
  select(forms, df, logLik, AICc, delta)

## then, round values
aic_df_beh_cond_late <- aic_df_beh_cond_late %>%
  mutate(across(where(is.numeric), ~round(.x, 3)))

# make model formulas pretty
aic_df_beh_cond_late <- aic_df_beh_cond_late %>% 
  mutate(
    forms = str_replace_all(forms, "avg_biom_herd", "forage biomass"),
    forms = str_replace_all(forms, "avg_de_herd", "dig. energy"),
    forms = str_replace_all(forms, "avg_fly_herd", "fly index"),
    forms = str_replace_all(forms, "avg_biom", "forage biomass use"),
    forms = str_replace_all(forms, "resource_vol", "forage use breadth"),
    forms = str_replace_all(forms, "avg_dn", "dig. nitrogen use"),
    forms = str_replace_all(forms, "avg_de", "dig. energy use"),
    forms = str_replace_all(forms, "avg_sinuosity", "daily sinuosity"),
    forms = str_replace_all(forms, "avg_dist_m", "daily displacement"),
    forms = str_replace_all(forms, "move_vol", "movement breadth"),
    forms = str_replace_all(forms, "HR_area_km2", "seasonal range area"),
    forms = str_replace_all(forms, "centroid_x", "seasonal range longitude"),
    forms = str_replace_all(forms, "centroid_y", "seasonal range latitude")
  ) %>% 
  filter(!str_detect(forms, "dig. nitrogen use")) # remove dig. nitrogen use from late summer

aic_df_beh_cond_late <- aic_df_beh_cond_late %>% mutate(forms = str_remove(forms, "Current_Calf_Present \\+\\ "))

aic_df_beh_cond_late <- aic_df_beh_cond_late %>% 
  mutate(forms = case_when(forms == "forage biomass + fly index" ~ "forage biomass + fly index (Null model, forage quantity)",
                           forms == "dig. energy + fly index" ~ "dig. energy + fly index (Null model, forage quality)",
                           TRUE ~ forms))

# format it as a flextable
ft <- flextable(aic_df_beh_cond_late)

# autofit column widths
ft <- autofit(ft)

# create a Word document and add the table
doc <- read_docx() %>%
  body_add_par("late behavior x condition parturition AIC", style = "heading 1") %>%
  body_add_flextable(ft)

# save the Word document
print(doc, target = "./Code_Output/late_behavior_cond_part_AIC.docx")
```

```{r}
# save models that are better than NULL for plotting
# save top models (delta AIC < NULL) for plotting
top_models <- list()

for(i in 1:length(aic_table)){
 delta_null <- aic_table[[i]] %>% 
    filter(str_detect(model, "NULL")) %>% 
  slice_min(delta) %>% 
    select(delta)
  
  top_aic_mod <- aic_table[[i]] %>% 
    filter(delta < delta_null$delta)
  
# pull models
  top_models[[i]] <- beh_cond_late_aic_mod[[i]][top_aic_mod$model]

}

top_models <- top_models %>%
  flatten() %>%
  keep(~ length(.) > 0)

# save models
saveRDS(top_models, "./Code_Output/late_cond_part_sig_models.rds")
```