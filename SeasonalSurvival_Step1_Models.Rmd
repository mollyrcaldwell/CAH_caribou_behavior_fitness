---
title: "Seasonal Survival: Step 1- Models"
output: html_document
date: "2025-09-16"
---

```{r}
library(glmmTMB)
library(tidyverse)
library(Hmisc)
library(corrplot)
library(MuMIn)
library(flextable)
library(officer)
library(readxl)
```

```{r setup}
setwd("~/OneDrive - University of Wyoming/Documents/USGS_AK_Caribou/")
```

# Load and prep data

```{r}
# early and late summer behaviors
early_beh <- readRDS("./Code_Output/early_beh_LMM_data.rds")
late_beh <- readRDS("./Code_Output/late_beh_LMM_data.rds")

# survival
 surv <- read_excel("./Data/IndividualCaribou.xlsx")
```

```{r}
# reformat survival to indicate whether an animal lives to the start of each summer (June 1)
surv_summ <-surv %>%
  mutate(
    capture_date = as.Date(`Initial Capture Date (AKT)`),
    death_date   = as.Date(`Death Date (UTC)`),
    censor_date  = as.Date(`Censor Date (UTC)`)
  ) %>%
  rowwise() %>%
  mutate(
    # last date we know something about the animal
    end_date = coalesce(death_date, censor_date, Sys.Date())
  ) %>%
  ungroup() %>%
  mutate(
    start_year = year(capture_date),
    end_year   = if_else(as.Date(end_date) <= as.Date(paste(year(end_date), "06-01", sep = "-")),
                         year(end_date), year(end_date) + 1)  # include 1st death June
  ) %>%
  rowwise() %>%
  mutate(years = list(start_year:end_year)) %>%
  unnest(years) %>%
  ungroup() %>%
  mutate(june1 = as.Date(paste0(years, "-06-01"))) %>%
  # only consider June 1 after capture
  filter(june1 >= capture_date) %>%
  mutate(alive_june1 = case_when(
      # only assign 0 if death_date exists and June 1 comes after it
      !is.na(death_date) & june1 > death_date ~ 0,
      june1 <= end_date ~ 1,
      TRUE ~ NA_integer_
    ))
  

# select variables of interest
surv_summ <- surv_summ %>% 
  select(`Animal Id`, years, Status, capture_date, death_date, censor_date, start_year, end_year, end_date,
         alive_june1)

# add animal_year of prior year to match with behavior data of prior year
surv_summ <- surv_summ %>% 
  mutate(animal_yr = paste(`Animal Id`, years - 1, sep = "_"))

```

```{r}
# combine behavior and fitness data
early_beh <- left_join(early_beh, surv_summ)
late_beh <- left_join(late_beh, surv_summ)
```

```{r}
# scale and center behaviors so they are on similar scales as conditions
behaviors <- c("avg_biom", "avg_dn", "avg_de", "resource_vol",
               "avg_dist_m", "avg_sinuosity", "HR_area_km2", "centroid_x",
               "centroid_y", "move_vol")
early_beh_sc <- early_beh %>% 
  mutate(across(all_of(behaviors), ~as.numeric(scale(.))))

late_beh_sc <- late_beh %>% 
  mutate(across(all_of(behaviors), ~as.numeric(scale(.))))

```

```{r}
# combine scaled & unscaled data together, for plots in step 2
early_beh <- early_beh %>%
  rename_with(~ paste0(.x, "_unscaled"),
              c("avg_biom", "avg_dn", "avg_de", "resource_vol",
                "avg_dist_m", "avg_sinuosity", "HR_area_km2", 
                "centroid_x", "centroid_y", "move_vol"))

late_beh <- late_beh %>%
  rename_with(~ paste0(.x, "_unscaled"),
              c("avg_biom", "avg_dn", "avg_de", "resource_vol",
                "avg_dist_m", "avg_sinuosity", "HR_area_km2", 
                "centroid_x", "centroid_y", "move_vol"))

early_beh <- left_join(early_beh, early_beh_sc)
late_beh <- left_join(late_beh, late_beh_sc)
```

```{r}
# save data used in models
saveRDS(early_beh, "./Code_Output/early_beh_surv_data.rds")
saveRDS(late_beh, "./Code_Output/late_beh_surv_data.rds")
```

## Seasonal behaviors

### Early summer
Effect of breadths & averages of early summer behaviors on the following year's survival

```{r}
# check correlation of annual behaviors
beh_metrics <- c("avg_biom", "I(avg_biom^2)", "avg_dn", "avg_de", "resource_vol",
                 "avg_dist_m", "avg_sinuosity", "HR_area_km2", "centroid_x",
               "centroid_y", "move_vol")

early_beh_corr = cor(early_beh %>% select(all_of(c("avg_biom", "avg_dn", 
                                               "avg_de", "resource_vol",
                                               "avg_dist_m", "avg_sinuosity", 
                                               "HR_area_km2", "centroid_x",
                                               "centroid_y", "move_vol"))) %>% 
                       rename(forage_biomass_use = avg_biom,
                              dig_nitrogen_use = avg_dn,
                              dig_energy_use = avg_de,
                              forage_breadth = resource_vol,
                              daily_displacement = avg_dist_m,
                              daily_sinuosity = avg_sinuosity,
                              seas_range_area = HR_area_km2,
                              seas_range_longitude = centroid_x,
                              seas_range_latitude = centroid_y,
                              movement_breadth = move_vol))
corrplot(early_beh_corr, method = 'number', number.cex = 0.7) 
```

```{r}
# loop through behavior metrics, running logistic model
beh_surv_early_mod <- vector(mode = "list", length = length(beh_metrics))

for(i in 1:length(beh_metrics)){
  print(i)
  
  form <- as.formula(paste("alive_june1 ~ ", beh_metrics[[i]]))
  
  beh_surv_early_mod[[i]] <- glmmTMB(formula = form,
                            data = early_beh,
                            family = binomial(link = "logit"))
}

names(beh_surv_early_mod) <- beh_metrics
```

```{r}
# compile model results into a dataframe
beh_surv_early_results <- vector(mode = "list", length = length(beh_surv_early_mod))

for(i in 1:length(beh_surv_early_mod)){
  
  beh_surv_early_results[[i]] <- as.data.frame(summary(beh_surv_early_mod[[i]])$coefficients$cond)
  beh_surv_early_results[[i]]$predictor <- rownames(beh_surv_early_results[[i]])
  rownames(beh_surv_early_results[[i]]) <- NULL
  
}

beh_surv_early_results <- bind_rows(beh_surv_early_results)

# filter out intercept
beh_surv_early_results <- beh_surv_early_results %>% 
  filter(predictor != "(Intercept)")

# arrange by p-value
beh_surv_early_results <- beh_surv_early_results %>% 
  arrange(`Pr(>|z|)`) 
```

### Behavior x annual forage & insect conditions
Effect of breadths & averages of early summer behaviors interacted with forage & insect conditions on the following year's survival

Conditions used: average and SD of biomass, DN, mosquito

```{r}
# name behavior metrics and conditions to loop over
beh_metrics <- c("avg_biom", "I(avg_biom^2)", "avg_dn", "avg_de", "resource_vol",
                 "avg_dist_m", "avg_sinuosity", "HR_area_km2", "centroid_x",
               "centroid_y", "move_vol")
cond_metrics <- c("avg_biom_herd", "avg_dn_herd")
```

```{r}
# loop through behavior metrics, running logistic model
beh_cond_surv_early_mod <- vector(mode = "list", length = length(beh_metrics))

for(i in 1:length(beh_metrics)){
  print(i)
  beh_cond_surv_early_mod[[i]] <- vector(mode = "list", length = length(cond_metrics))
  
  for(j in 1:length(cond_metrics)){
  
  form <- as.formula(paste("alive_june1 ~ ", beh_metrics[[i]],
                           " * avg_mosq_herd + ", beh_metrics[[i]], " * ",
                           cond_metrics[[j]]))
  
  beh_cond_surv_early_mod[[i]][[j]] <- glmmTMB(formula = form,
                            data = early_beh,
                            family = binomial(link = "logit"))

  }
  
  names(beh_cond_surv_early_mod[[i]]) <- cond_metrics
}

names(beh_cond_surv_early_mod) <- beh_metrics
```

```{r}
# compile model results into a dataframe
beh_cond_surv_early_results <- vector(mode = "list", length = length(beh_cond_surv_early_mod))

for(i in 1:length(beh_cond_surv_early_mod)){
  beh_cond_surv_early_results[[i]] <- vector(mode = "list", 
                                       length = length(beh_cond_surv_early_mod[[i]]))
  
  for(j in 1:length(beh_cond_surv_early_mod[[i]])){
    beh_cond_surv_early_results[[i]][[j]] <- vector(mode = "list", 
                                       length = length(beh_cond_surv_early_mod[[i]][[j]]))
    
      
  beh_cond_surv_early_results[[i]][[j]] <- as.data.frame(summary(beh_cond_surv_early_mod[[i]][[j]])$coefficients$cond)
  beh_cond_surv_early_results[[i]][[j]]$beh <- names(beh_cond_surv_early_mod)[[i]]
  beh_cond_surv_early_results[[i]][[j]]$cond <- names(beh_cond_surv_early_mod[[i]])[[j]]
  beh_cond_surv_early_results[[i]][[j]]$predictor <- rownames(beh_cond_surv_early_results[[i]][[j]])
  rownames(beh_cond_surv_early_results[[i]][[j]]) <- NULL
    }
    beh_cond_surv_early_results[[i]] <- bind_rows(beh_cond_surv_early_results[[i]])
  }


beh_cond_surv_early_results <- bind_rows(beh_cond_surv_early_results)

# filter out intercept
beh_cond_surv_early_results <- beh_cond_surv_early_results %>% 
  filter(predictor != "(Intercept)")

# arrange by p-value
beh_cond_surv_early_results <- beh_cond_surv_early_results %>% 
  arrange(`Pr(>|z|)`)
```

```{r}
# replace models with insignificant interactions with model without interaction
beh_cond_surv_early_mod[[1]][[1]] <- glmmTMB(alive_june1 ~ avg_biom * avg_biom_herd +
                                          avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[1]][[2]] <- glmmTMB(alive_june1 ~ avg_biom + avg_dn_herd +
                                          avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[2]][[1]] <- glmmTMB(alive_june1 ~ I(avg_biom^2) +
                                               avg_biom_herd +
                                          avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[2]][[2]] <- glmmTMB(alive_june1 ~ I(avg_biom^2) +
                                               avg_dn_herd +
                                          avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[3]][[1]] <- glmmTMB(alive_june1 ~ avg_dn +
                                               avg_biom_herd +
                                          avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[3]][[2]] <- glmmTMB(alive_june1 ~ avg_dn +
                                               avg_dn_herd +
                                          avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[4]][[1]] <- glmmTMB(alive_june1 ~ avg_de +
                                               avg_biom_herd +
                                          avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[4]][[2]] <- glmmTMB(alive_june1 ~ avg_de +
                                               avg_dn_herd +
                                          avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[5]][[1]] <- glmmTMB(alive_june1 ~ 
                                               resource_vol + avg_biom_herd +
                                            avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[5]][[2]] <- glmmTMB(alive_june1 ~ 
                                               resource_vol + avg_dn_herd +
                                        avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[6]][[1]] <- glmmTMB(alive_june1 ~ avg_dist_m * avg_mosq_herd +
                                               avg_biom_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[6]][[2]] <- glmmTMB(alive_june1 ~ avg_dist_m * avg_mosq_herd +
                                               avg_dn_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[7]][[1]] <- glmmTMB(alive_june1 ~ avg_sinuosity +
                                               avg_mosq_herd +
                                               avg_biom_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[7]][[2]] <- glmmTMB(alive_june1 ~ avg_sinuosity +
                                               avg_mosq_herd +
                                               avg_dn_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[8]][[1]] <- glmmTMB(alive_june1 ~ HR_area_km2 * avg_biom_herd +
                                               avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[8]][[2]] <- glmmTMB(alive_june1 ~ HR_area_km2 + avg_dn_herd +
                                               avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[9]][[1]] <- glmmTMB(alive_june1 ~ centroid_x + avg_biom_herd +
                                               avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[9]][[2]] <- glmmTMB(alive_june1 ~ centroid_x + avg_dn_herd +
                                               avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[10]][[1]] <- glmmTMB(alive_june1 ~ centroid_y + avg_biom_herd +
                                               avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[10]][[2]] <- glmmTMB(alive_june1 ~ centroid_y + avg_dn_herd +
                                               avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[11]][[1]] <- glmmTMB(alive_june1 ~ move_vol + avg_biom_herd +
                                               avg_mosq_herd +
                                                move_vol:avg_sinuosity,
                            data = early_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_early_mod[[11]][[2]] <- glmmTMB(alive_june1 ~ move_vol +
                                               avg_mosq_herd +
                                               avg_dn_herd + move_vol:avg_sinuosity,
                            data = early_beh,
                            family = binomial(link = "logit"))
```


```{r}
# AIC table
## first, rearrange model list, so that models are in a list per response (survuritient or post-calf present)
## first, rearrange model list
beh_cond_early_aic_mod <- list()
for (parent in names(beh_cond_surv_early_mod)) {
  for (child in names(beh_cond_surv_early_mod[[parent]])) {
    beh_cond_early_aic_mod[[paste(parent, child, sep = " ")]] <- beh_cond_surv_early_mod[[parent]][[child]]
  }
}


# add null model 
beh_cond_early_aic_mod[[23]] <- glmmTMB(alive_june1 ~ avg_biom_herd + avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

names(beh_cond_early_aic_mod)[[23]] <- "NULL_biom"

beh_cond_early_aic_mod[[24]] <- glmmTMB(alive_june1 ~ avg_dn_herd + avg_mosq_herd,
                            data = early_beh,
                            family = binomial(link = "logit"))

names(beh_cond_early_aic_mod)[[24]] <- "NULL_dn"
```

```{r}
  # Generate AIC table 
  aic_table <- MuMIn::model.sel(beh_cond_early_aic_mod)

# extract model formula
forms <- map_chr(beh_cond_early_aic_mod, ~as.character(formula(.x))[[3]])
forms <- data.frame(forms = forms, model = names(beh_cond_early_aic_mod))
  
# Add model names 
  aic_df_beh_cond_early <- as.data.frame(aic_table) %>%
    tibble::rownames_to_column("model")
  
  # join with formula
  aic_df_beh_cond_early <- left_join(aic_df_beh_cond_early, forms)

## subset to variables of interest
aic_df_beh_cond_early <- aic_df_beh_cond_early %>% 
  select(model, forms, df, logLik, AICc, delta)

## then, round values
aic_df_beh_cond_early <- aic_df_beh_cond_early %>%
  mutate(across(where(is.numeric), ~round(.x, 3)))
```

```{r}
# output word docx AIC tables
# format it as a flextable
ft <- flextable(aic_df_beh_cond_early)

# autofit column widths
ft <- autofit(ft)

# create a Word document and add the table
doc <- read_docx() %>%
  body_add_par("Early behavior x condition survival AIC", style = "heading 1") %>%
  body_add_flextable(ft)

# save the Word document
print(doc, target = "./Code_Output/early_behavior_cond_surv_AIC.docx")
```

```{r}
# save top models (delta AIC < NULL - 1) for plotting
   
 delta_null <- aic_df_beh_cond_early %>% 
    filter(str_detect(model, "NULL")) %>% 
  slice_min(delta) %>% 
    select(delta)
  
  top_aic_mod <- aic_df_beh_cond_early %>% 
    filter(delta < (delta_null$delta-1))
  
# pull models
  top_models <- beh_cond_early_aic_mod[top_aic_mod$model]

# save models
saveRDS(top_models, "./Code_Output/early_cond_surv_sig_models.rds")
```

### Late summer
Effect of breadths & averages of late summer behaviors on the following year's survival

```{r}
# check correlation of late summer behaviors
beh_metrics <- c("avg_biom", "I(avg_biom^2)", "avg_dn", "avg_de", "resource_vol",
                 "avg_dist_m", "avg_sinuosity", "HR_area_km2", "centroid_x",
               "centroid_y", "move_vol")

late_beh_corr = cor(late_beh %>% select(all_of(c("avg_biom", "avg_dn", 
                                               "avg_de", "resource_vol",
                                               "avg_dist_m", "avg_sinuosity", 
                                               "HR_area_km2", "centroid_x",
                                               "centroid_y", "move_vol"))) %>% 
                      rename(forage_biomass_use = avg_biom,
                              dig_nitrogen_use = avg_dn,
                              dig_energy_use = avg_de,
                              forage_breadth = resource_vol,
                              daily_displacement = avg_dist_m,
                              daily_sinuosity = avg_sinuosity,
                              seas_range_area = HR_area_km2,
                              seas_range_longitude = centroid_x,
                              seas_range_latitude = centroid_y,
                              movement_breadth = move_vol))
corrplot(late_beh_corr, method = 'number', number.cex = 0.7) 
```

```{r}
# loop through behavior metrics, running logistic model
beh_surv_late_mod <- vector(mode = "list", length = length(beh_metrics))

for(i in 1:length(beh_metrics)){
  print(i)
  
  form <- as.formula(paste("alive_june1 ~ ", beh_metrics[[i]]))
  
  beh_surv_late_mod[[i]] <- glmmTMB(formula = form,
                            data = late_beh,
                            family = binomial(link = "logit"))
}

names(beh_surv_late_mod) <- beh_metrics
```

```{r}
# compile model results into a dataframe
beh_surv_late_results <- vector(mode = "list", length = length(beh_surv_late_mod))

for(i in 1:length(beh_surv_late_mod)){
  
  beh_surv_late_results[[i]] <- as.data.frame(summary(beh_surv_late_mod[[i]])$coefficients$cond)
  beh_surv_late_results[[i]]$predictor <- rownames(beh_surv_late_results[[i]])
  rownames(beh_surv_late_results[[i]]) <- NULL
  
}

beh_surv_late_results <- bind_rows(beh_surv_late_results)

# filter out intercept
beh_surv_late_results <- beh_surv_late_results %>% 
  filter(predictor != "(Intercept)")

# arrange by p-value
beh_surv_late_results <- beh_surv_late_results %>% 
  arrange(`Pr(>|z|)`) 
```


### Behavior x annual forage & insect conditions
Effect of breadths & averages of late summer behaviors interacted with forage & insect conditions on the following year's survival

Conditions used: average and SD of biomass and fly indices

```{r}
# name behavior metrics and conditions to loop over
beh_metrics <- c("avg_biom", "I(avg_biom^2)", "avg_dn", "avg_de", "resource_vol",
                 "avg_dist_m", "avg_sinuosity", "HR_area_km2", "centroid_x",
               "centroid_y", "move_vol")
cond_metrics <- c("avg_biom_herd",  "avg_de_herd")
```

```{r}
# loop through behavior metrics, running logistic model
beh_cond_surv_late_mod <- vector(mode = "list", length = length(beh_metrics))

for(i in 1:length(beh_metrics)){
  print(i)
  beh_cond_surv_late_mod[[i]] <- vector(mode = "list", length = length(cond_metrics))
  
  for(j in 1:length(cond_metrics)){
  
  form <- as.formula(paste("alive_june1 ~ ", beh_metrics[[i]],
                           " * avg_fly_herd + ", beh_metrics[[i]], " * ",
                           cond_metrics[[j]]))
  
  beh_cond_surv_late_mod[[i]][[j]] <- glmmTMB(formula = form,
                            data = late_beh,
                            family = binomial(link = "logit"))

  }
  
  names(beh_cond_surv_late_mod[[i]]) <- cond_metrics
}

names(beh_cond_surv_late_mod) <- beh_metrics
```

```{r}
# compile model results into a dataframe
beh_cond_surv_late_results <- vector(mode = "list", length = length(beh_cond_surv_late_mod))

for(i in 1:length(beh_cond_surv_late_mod)){
  beh_cond_surv_late_results[[i]] <- vector(mode = "list", 
                                       length = length(beh_cond_surv_late_mod[[i]]))
  
  for(j in 1:length(beh_cond_surv_late_mod[[i]])){
    beh_cond_surv_late_results[[i]][[j]] <- vector(mode = "list", 
                                       length = length(beh_cond_surv_late_mod[[i]][[j]]))
    
      
  beh_cond_surv_late_results[[i]][[j]] <- as.data.frame(summary(beh_cond_surv_late_mod[[i]][[j]])$coefficients$cond)
  beh_cond_surv_late_results[[i]][[j]]$beh <- names(beh_cond_surv_late_mod)[[i]]
  beh_cond_surv_late_results[[i]][[j]]$cond <- names(beh_cond_surv_late_mod[[i]])[[j]]
  beh_cond_surv_late_results[[i]][[j]]$predictor <- rownames(beh_cond_surv_late_results[[i]][[j]])
  rownames(beh_cond_surv_late_results[[i]][[j]]) <- NULL
    }
    beh_cond_surv_late_results[[i]] <- bind_rows(beh_cond_surv_late_results[[i]])
  }


beh_cond_surv_late_results <- bind_rows(beh_cond_surv_late_results)

# filter out intercept
beh_cond_surv_late_results <- beh_cond_surv_late_results %>% 
  filter(predictor != "(Intercept)")

# arrange by p-value
beh_cond_surv_late_results <- beh_cond_surv_late_results %>% 
  arrange(`Pr(>|z|)`)
```

```{r}
# replace models with insignificant interactions with model without interaction
beh_cond_surv_late_mod[[1]][[1]] <- glmmTMB(alive_june1 ~ avg_biom +
                                              avg_biom_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[1]][[2]] <- glmmTMB(alive_june1 ~ avg_biom +
                                              avg_de_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[2]][[1]] <- glmmTMB(alive_june1 ~ I(avg_biom^2) +
                                              avg_biom_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[2]][[2]] <- glmmTMB(alive_june1 ~ I(avg_biom^2) +
                                              avg_de_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[3]][[1]] <- glmmTMB(alive_june1 ~ avg_dn +
                                              avg_biom_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[3]][[2]] <- glmmTMB(alive_june1 ~ avg_dn +
                                              avg_de_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[4]][[1]] <- glmmTMB(alive_june1 ~ avg_de +
                                              avg_biom_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[4]][[2]] <- glmmTMB(alive_june1 ~ avg_de +
                                              avg_de_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[5]][[1]] <- glmmTMB(alive_june1 ~ 
                                              resource_vol * avg_biom_herd +
                                               avg_fly_herd +
                                              resource_vol : avg_de,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[5]][[2]] <- glmmTMB(alive_june1 ~ 
                                              resource_vol * avg_de_herd +
                                               avg_fly_herd +
                                              avg_biom +
                                              avg_de +
                                              resource_vol * avg_dn,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[6]][[1]] <- glmmTMB(alive_june1 ~ avg_dist_m +
                                              avg_biom_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[6]][[2]] <- glmmTMB(alive_june1 ~ avg_dist_m +
                                              avg_de_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[7]][[1]] <- glmmTMB(alive_june1 ~ avg_sinuosity +
                                              avg_biom_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[7]][[2]] <- glmmTMB(alive_june1 ~ avg_sinuosity +
                                              avg_de_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[8]][[1]] <- glmmTMB(alive_june1 ~ HR_area_km2 +
                                              avg_biom_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[8]][[2]] <- glmmTMB(alive_june1 ~ HR_area_km2 +
                                              avg_de_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[9]][[1]] <- glmmTMB(alive_june1 ~ centroid_x +
                                              avg_biom_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[9]][[2]] <- glmmTMB(alive_june1 ~ centroid_x +
                                              avg_de_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[10]][[1]] <- glmmTMB(alive_june1 ~ centroid_y +
                                              avg_biom_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[10]][[2]] <- glmmTMB(alive_june1 ~ centroid_y +
                                              avg_de_herd +
                                          avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[11]][[1]] <- glmmTMB(alive_june1 ~ 
                                               move_vol * avg_biom_herd +
                                               avg_fly_herd +
                                               move_vol * avg_sinuosity +
                                               move_vol : avg_dist_m,
                            data = late_beh,
                            family = binomial(link = "logit"))

beh_cond_surv_late_mod[[11]][[2]] <- glmmTMB(alive_june1 ~ 
                                               move_vol * avg_de_herd +
                                                avg_fly_herd +
                                               move_vol * avg_sinuosity +
                                               move_vol : avg_dist_m,
                            data = late_beh,
                            family = binomial(link = "logit"))

```


```{r}
# AIC table
## first, rearrange model list, so that models are in a list per response (survuritient or post-calf present)
## first, rearrange model list
beh_cond_late_aic_mod <- list()
for (parent in names(beh_cond_surv_late_mod)) {
  for (child in names(beh_cond_surv_late_mod[[parent]])) {
    beh_cond_late_aic_mod[[paste(parent, child, sep = " ")]] <- beh_cond_surv_late_mod[[parent]][[child]]
  }
}


# add null model 
beh_cond_late_aic_mod[[23]] <- glmmTMB(alive_june1 ~ avg_biom_herd + avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

names(beh_cond_late_aic_mod)[[23]] <- "NULL_biom"

beh_cond_late_aic_mod[[24]] <- glmmTMB(alive_june1 ~ avg_de_herd + avg_fly_herd,
                            data = late_beh,
                            family = binomial(link = "logit"))

names(beh_cond_late_aic_mod)[[24]] <- "NULL_de"
```

```{r}
  # Generate AIC table 
  aic_table <- MuMIn::model.sel(beh_cond_late_aic_mod)
  
# extract model formula
forms <- map_chr(beh_cond_late_aic_mod, ~as.character(formula(.x))[[3]])
forms <- data.frame(forms = forms, model = names(beh_cond_late_aic_mod))
  
# Add model names 
  aic_df_beh_cond_late <- as.data.frame(aic_table) %>%
    tibble::rownames_to_column("model")
  
  # join with formula
  aic_df_beh_cond_late <- left_join(aic_df_beh_cond_late, forms)

## subset to variables of interest
aic_df_beh_cond_late <- aic_df_beh_cond_late %>% 
  select(model, forms, df, logLik, AICc, delta)

## then, round values
aic_df_beh_cond_late <- aic_df_beh_cond_late %>%
  mutate(across(where(is.numeric), ~round(.x, 3)))
```

```{r}
# output word docx AIC tables
# format it as a flextable
ft <- flextable(aic_df_beh_cond_late)

# autofit column widths
ft <- autofit(ft)

# create a Word document and add the table
doc <- read_docx() %>%
  body_add_par("Late behavior x condition survival AIC", style = "heading 1") %>%
  body_add_flextable(ft)

# save the Word document
print(doc, target = "./Code_Output/late_behavior_cond_surv_AIC.docx")
```

```{r}
# save top models (delta AIC < NULL) for plotting
   
 delta_null <- aic_df_beh_cond_late %>% 
    filter(str_detect(model, "NULL")) %>% 
    slice_min(delta) %>% 
    select(delta)
  
  top_aic_mod <- aic_df_beh_cond_late %>% 
    filter(delta < delta_null$delta)
  
# pull models
  top_models <- beh_cond_late_aic_mod[top_aic_mod$model]

# save models
saveRDS(top_models, "./Code_Output/late_cond_surv_sig_models.rds")
```
